{% extends "layout.html" %}

{% block content %}
<div class="dashboard">

  <!-- Header -->
  <header class="site-header">
    <h1>Smart Breathe</h1>
    <nav>
      <span>Welcome, {{ data.user_name }}</span>
      <a href="/signout">Sign Out</a>
    </nav>
  </header>

  <!-- Real-Time Alert -->
  {% if data.risk.classification in ['High', 'Critical'] %}
  <div class="alert alert--danger">
    ⚠️ Real-Time Alert: Hyperlocal environmental risk is extremely high. Secure indoor air environments advised immediately.
  </div>
  {% endif %}

  <!-- Exposure Risk -->
  <section class="card card--risk">
    <h2>Exposure Risk</h2>

    {% set rclass = 'low' %}
    {% if data.risk.classification == 'Moderate' %}
      {% set rclass = 'mod' %}
    {% elif data.risk.classification == 'High' %}
      {% set rclass = 'high' %}
    {% elif data.risk.classification == 'Critical' %}
      {% set rclass = 'crit' %}
    {% endif %}

    <div class="risk-score risk-score--{{ rclass }}">
      <span class="score-value">{{ data.risk.score|int }}</span>
      <span class="score-label">{{ data.risk.classification }}</span>
    </div>
    <p class="trend">Forecast Trend: {{ data.risk.trend }}</p>
  </section>

  <!-- Health Recommendations -->
  <section class="card card--recommendations">
    <h2>Health Recommendations</h2>
    <ul>
      {% if data.risk.classification == 'Low' %}
        <li>Ideal conditions for outdoor cardiovascular exercise.</li>
        <li>Ventilate indoor spaces by opening windows.</li>
      {% elif data.risk.classification == 'Moderate' %}
        <li>Sensitive groups should consider limiting prolonged outdoor exertion.</li>
        <li>Monitor your SpO2 fluctuations if asthmatic.</li>
      {% elif data.risk.classification == 'High' %}
        <li>Minimize outdoor exposure. Carry rescue inhaler.</li>
        <li>Close windows and activate indoor HEPA filtration.</li>
        <li>Your simulated airway resistance is elevated.</li>
      {% else %}
        <li>CRITICAL: Immediate health risk. Stay indoors.</li>
        <li>Your respiratory biomarkers indicate extreme stress.</li>
        <li>Predicted AQI combined with topology increases toxin exposure.</li>
      {% endif %}
    </ul>
  </section>

  <!-- AI Insights (XAI) -->
  <section class="card card--insights">
    <h2>AI Insights (XAI)</h2>
    <p>Top contributing factors to your score:</p>
    <ul>
      <li>Predicted Local AQI ({{ data.predicted_aqi }})</li>
      <li>Traffic Density ({{ (data.env.traffic_density * 100)|int }}%)</li>
      <li>Urban Topology Multiplier ({{ data.env.urban_topology }})</li>
    </ul>
  </section>

  <!-- Biomarker Telemetry -->
  <section class="card card--biomarkers">
    <h2>Biomarker Telemetry</h2>
    <div class="metrics-grid">
      <div class="metric">
        <span class="metric__value">{{ data.bio.breathing_rate_variability }}</span>
        <span class="metric__label">Breath Variab.</span>
      </div>
      <div class="metric">
        <span class="metric__value">{{ data.bio.spo2_fluctuation }}%</span>
        <span class="metric__label">SpO2 Drop</span>
      </div>
      <div class="metric">
        <span class="metric__value">{{ data.bio.cough_frequency }}</span>
        <span class="metric__label">Coughs / hr</span>
      </div>
      <div class="metric">
        <span class="metric__value">{{ data.bio.airway_resistance }}</span>
        <span class="metric__label">Airway Resist.</span>
      </div>
    </div>
  </section>

  <!-- Environmental Context -->
  <section class="card card--environment">
    <h2>Environmental Context</h2>
    <div class="metrics-grid">
      <div class="metric">
        <span class="metric__value">{{ data.predicted_aqi }}</span>
        <span class="metric__label">Predicted AQI</span>
      </div>
      <div class="metric">
        <span class="metric__value">{{ data.env.traffic_density * 100 }}%</span>
        <span class="metric__label">Traffic Idx</span>
      </div>
      <div class="metric">
        <span class="metric__value">{{ data.env.humidity }}%</span>
        <span class="metric__label">Humidity</span>
      </div>
      <div class="metric">
        <span class="metric__value">{{ data.env.urban_topology }}</span>
        <span class="metric__label">Topology Idx</span>
      </div>
    </div>
  </section>

  <!-- Hyperlocal Pollutant Topography -->
  <section class="card card--map">
    <h2>Hyperlocal Pollutant Topography</h2>
    <div class="map-placeholder">
      <!-- Map renders here -->
    </div>
    <div class="aqi-legend">
      <h3>AQI Legend</h3>
      <ul>
        <li><span class="legend-dot legend-dot--good"></span> Good (0–50)</li>
        <li><span class="legend-dot legend-dot--moderate"></span> Moderate (51–100)</li>
        <li><span class="legend-dot legend-dot--unhealthy"></span> Unhealthy (101–200)</li>
        <li><span class="legend-dot legend-dot--hazardous"></span> Hazardous (&gt;200)</li>
      </ul>
    </div>
  </section>

</div>
{% endblock %}

{% block scripts %}{% endblock %}